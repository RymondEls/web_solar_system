# Документация симулятора Солнечной системы

**Симулятор Солнечной системы** — это веб-приложение, которое моделирует орбитальное движение небесных тел (звёзд, планет, комет, космических аппаратов) в двухмерном пространстве. Пользователи могут визуализировать движение тел, управлять параметрами симуляции (пауза, масштаб времени, слежение за телами), изучать характеристики тел (атмосферу, поверхность) и запускать космические аппараты. Приложение состоит из серверной части (Python, FastAPI) и клиентской части (HTML, JavaScript, Canvas), взаимодействующих через HTTP и WebSocket.

### Основные возможности
- Визуализация движения небесных тел в реальном времени.
- Управление сценой: пауза, ускорение/замедление времени, масштабирование, перемещение.
- Слежение за выбранным телом (например, Солнце, Земля).
- Изучение характеристик тел: атмосфера, поверхность, общие данные.
- Запуск космических аппаратов с настраиваемыми параметрами.
- Сохранение состояния симуляции в JSON.

## Архитектура

Проект разделён на серверную и клиентскую части, взаимодействующие через API и WebSocket:

- **Сервер** (`main.py`):
  - Реализован на Python с использованием FastAPI.
  - Выполняет симуляцию орбитального движения.
  - Обрабатывает HTTP-запросы и WebSocket-сообщения.
  - Хранит состояние сцены и тел.
- **Клиент** (`index.html`):
  - Веб-интерфейс на HTML, CSS, JavaScript.
  - Рендерит тела на HTML5 Canvas.
  - Обрабатывает действия пользователя (мышь, клавиатура).
  - Взаимодействует с сервером через HTTP и WebSocket.
- **Данные** (`solar_system.json`):
  - JSON-файл с начальными параметрами тел (масса, позиция, скорость и т.д.).
- **Вспомогательные модули**:
  - `utils`, `operations`, `entities` — содержат логику загрузки данных, симуляции и классы тел.

### Технологии
- **Сервер**:
  - Python 3.8+
  - FastAPI (асинхронный веб-фреймворк)
  - Uvicorn (ASGI-сервер)
  - NumPy (вычисления)
  - Pydantic (валидация данных)
  - WebSocket (реальное время)
- **Клиент**:
  - HTML5, CSS, JavaScript
  - HTML5 Canvas (рендеринг)
- **Формат данных**:
  - JSON (хранение тел и состояния)

### Поток данных
1. Сервер загружает `solar_system.json` и инициализирует список тел (`bodies`).
2. В WebSocket-цикле сервер выполняет симуляцию (`simulate_orbits`), обновляет позиции тел и отправляет данные клиенту каждые 0.05 секунды.
3. Клиент получает данные через WebSocket, рендерит тела на канвасе, используя масштаб и смещение сцены.
4. Пользователь взаимодействует через интерфейс (например, пауза, слежение), отправляя HTTP-запросы на сервер.
5. Сервер обновляет состояние и передаёт изменения клиенту.

## Компоненты проекта

### 1. `main.py` (Сервер)

**Назначение**: Основной серверный файл, реализующий симуляцию, API и WebSocket.

#### Структура
- **Импорты**:
  - Стандартные: `json`, `asyncio`, `logging`, `time`.
  - FastAPI: `FastAPI`, `WebSocket`, `HTTPException`, `HTMLResponse`, `StaticFiles`.
  - Pydantic: `BaseModel` (валидация).
  - NumPy: вычисления.
  - Модули проекта: `utils.json_load`, `operations.orbit_simulation`, `utils.scene_interaction`, `entities.spacecraft`.
- **Инициализация**:
  - Настройка логирования (`logging.INFO`).
  - Создание FastAPI-приложения.
  - Монтирование папки `static` для отдачи `index.html`.
- **Загрузка тел**:
  - Читает `solar_system.json` через `load_bodies_from_json`.
  - Логирует имена тел и позицию Солнца.
  - Устанавливает начальное смещение сцены для центрирования Солнца.
- **Сцена**:
  - Класс `SceneInteraction` хранит параметры: `scale`, `offset`, `tracked_body`, `pause`, `time_scale`.
  - Начальные значения: `scale=250/1.496e11` (1 а.е. = 250 пикселей), `offset=[960, 480]`, `tracked_body="Sun"`.
  - Шаг времени: `dt=3600` (1 час).
- **Модели Pydantic**:
  - `BodyData`: описание тела (имя, масса, позиция и т.д.).
  - `SceneData`: параметры сцены.
  - `SpacecraftLaunch`: данные для запуска аппарата.
  - `PanData`: данные для перемещения сцены (dx, dy).
- **WebSocket (`/ws/simulation`)**:
  - Выполняет симуляцию (`simulate_orbits`) при отсутствии паузы.
  - Обновляет траектории тел (до 100 точек).
  - Центрирует сцену на `tracked_body`.
  - Отправляет данные клиенту каждые 0.05 секунды.
- **HTTP-эндпоинты**:
  - `GET /`: отдаёт `index.html`.
  - `GET /bodies`: возвращает список тел.
  - `POST /scene/pause`: переключает паузу.
  - `POST /scene/time_scale/{factor}`: изменяет масштаб времени (0.1x–50x).
  - `POST /scene/zoom/{factor}`: изменяет масштаб сцены.
  - `POST /scene/pan`: смещает сцену.
  - `POST /scene/track/{body_name}`: начинает слежение.
  - `POST /scene/untrack`: отключает слежение.
  - `POST /spacecraft/launch`: добавляет аппарат.
  - `GET /study/atmosphere/{body_name}`, `/study/surface/{body_name}`, `/collect/data/{body_name}`: возвращают данные тела.
  - `GET /trajectory/{body_name}`: возвращает траекторию.
  - `POST /save`: сохраняет состояние в `solar_system_state.json`.

#### Роль
- Управляет симуляцией (физика, состояние).
- Предоставляет API для взаимодействия с клиентом.
- Передаёт данные через WebSocket для рендеринга.

### 2. `index.html` (Клиент)

**Назначение**: Веб-интерфейс для визуализации и управления симуляцией.

#### Структура
- **HTML**:
  - `<canvas id="simulationCanvas">`: область для рендеринга.
  - `<div id="controls">`: кнопки (пауза, ускорение, замедление, меню) и статус (масштаб времени, пауза).
  - `<div id="menu">`: меню с выбором действий (атмосфера, поверхность, данные, запуск, слежение), списком тел и формой для аппарата.
- **CSS**:
  - Полноэкранный канвас (`width: 100vw`, `height: calc(100vh - 60px)`).
  - Полупрозрачные элементы управления.
  - Чёткое отображение (`image-rendering: crisp-edges`).
- **JavaScript**:
  - **Инициализация**: настройка канваса, WebSocket, переменных (`bodies`, `scene`).
  - **WebSocket**: подключение к `/ws/simulation`, обработка данных, рендеринг.
  - **Рендеринг** (`drawBodies`): рисует тела как круги с цветом, радиусом, подписями; для комет добавляет хвост.
  - **Управление**:
    - `togglePause`, `adjustTimeScale`, `zoom`, `pan`: отправляют HTTP-запросы.
    - `toggleMenu`, `updateMenu`, `updateBodySelect`: управляют меню и списком тел.
    - `executeMenuAction`: выполняет действия (изучение, запуск, слежение).
  - **События**:
    - Мышь: перетаскивание (`mousedown`, `mousemove`, `mouseup`), масштабирование (`wheel`).
    - Клавиатура: P (пауза), +/- (время), M (меню).

#### Роль
- Визуализирует симуляцию на канвасе.
- Обрабатывает пользовательский ввод.
- Отправляет команды на сервер.

### 3. `solar_system.json` (Данные)

**Назначение**: Хранит начальные параметры небесных тел.

#### Структура
```json
[
    {
        "name": "Sun",
        "type": "star",
        "mass": 1.989e30,
        "position": [0, 0],
        "velocity": [0, 0],
        "color": [255, 255, 0],
        "radius": 696340000,
        "temperature": 5500
    },
    {
        "name": "Earth",
        "type": "planet",
        "mass": 5.972e24,
        "position": [1.496e11, 0],
        "velocity": [0, 29780],
        "color": [0, 0, 255],
        "radius": 6371000,
        "atmosphere": "Nitrogen, Oxygen",
        "surface": "Rocky"
    }
]
```
- **Поля**:
  - `name`, `type`, `mass`, `position`, `velocity`, `color`, `radius`.
  - Опционально: `temperature`, `atmosphere`, `surface`, `tail_length`, `mission`.

#### Роль
- Задаёт начальные условия симуляции.
- Определяет визуальные и физические характеристики тел.

### 4. Вспомогательные модули

#### `utils/json_load.py`
- **Функции**:
  - `load_bodies_from_json`: загружает тела, создаёт объекты (`Star`, `Planet`, `Spacecraft`).
  - `save_bodies_to_json`: сохраняет тела в JSON.
- **Роль**: Загрузка и сохранение данных.

#### `operations/orbit_simulation.py`
- **Функция** `simulate_orbits(bodies, dt, time_scale)`:
  - Рассчитывает гравитационные силы по закону Ньютона.
  - Обновляет позиции и скорости.
- **Роль**: Физический движок симуляции.

#### `utils/scene_interaction.py`
- **Класс** `SceneInteraction`:
  - Хранит параметры сцены: `scale`, `offset`, `tracked_body`, `pause`, `time_scale`.
- **Роль**: Управление параметрами отображения.

#### `entities/spacecraft.py`
- **Класс** `Spacecraft`:
  - Определяет космический аппарат.
- **Роль**: Добавление новых тел.

## Физическая основа

- **Модель**: 2D-движение по законам Ньютона.
- **Гравитация**:
  \[
  F = G \cdot \frac{m_1 \cdot m_2}{r^2}
  \]
  где \( G = 6.67430 \times 10^{-11} \, \text{м}^3 \text{кг}^{-1} \text{с}^{-2} \).
- **Упрощения**:
  - Игнорируются релятивистские эффекты, трение, 3D-движение.
  - Масштаб: 1 а.е. = 250 пикселей, 1 час = `dt`.

### Запуск
1. Запустите сервер из корня проекта:
   ```bash
   uvicorn.exe main:app --reload
   ```
2. Откройте `http://localhost:8000` в браузере.

### Проверка
- Логи сервера:
  - `Loaded X bodies from solar_system.json`.
  - `Sun position: [X, Y]`.
- Интерфейс:
  - Солнце в центре канваса.
  - Панель управления и меню отображаются.
  - Возможность паузы, масштабирования, слежения.

## Использование

1. **Управление**:
   - **Клавиши**:
     - `P`: пауза.
     - `+`/`-`: ускорение/замедление времени.
     - `M`: открыть/закрыть меню.
   - **Мышь**:
     - Перетаскивание: перемещение сцены.
     - Колесо: масштабирование.
   - **Кнопки**: пауза, ускорение, замедление, меню.
2. **Меню**:
   - Выберите действие: атмосфера, поверхность, данные, запуск, слежение.
   - Для действий 1–3, 5: выберите тело.
   - Для запуска: заполните форму (имя, масса, радиус, миссия, скорость).
3. **Слежение**:
   - Выберите тело, сцена центрируется на нём.
4. **Сохранение**:
   - Используйте эндпоинт `POST /save` (через код или расширение).

## Ограничения
- 2D-модель (без учёта Z-координаты).
- Ограничение траекторий (100 точек).
- Производительность зависит от количества тел.
- Нет визуализации траекторий на канвасе.

## Возможные улучшения
- Добавить 3D-движение.
- Визуализировать траектории.
- Оптимизировать симуляцию для большого числа тел.
- Добавить редактор `solar_system.json` в интерфейсе.
- Реализовать столкновения тел.

## Отладка
- **Логи сервера**:
  - Проверяйте терминал: загрузка тел, запросы, ошибки WebSocket.
- **Логи клиента**:
  - Откройте консоль браузера (F12): рендеринг, WebSocket, запросы.
- **Типичные проблемы**:
  - Ошибка 422 в `/scene/pan`: проверьте `dx`, `dy`.
  - Тело не найдено: убедитесь, что оно есть в `solar_system.json`.
